name: Docker CI/CD

on:
  push:
    branches: [ "main" ]

permissions:
  contents: read
  packages: write
  id-token: write
  
jobs:
  build:
    runs-on: ubuntu-latest
    
    permissions:
      contents: read
      packages: write
      id-token: write
      
    steps:
    # 1. CHECKOUT (visible)
    - name: "ğŸ“¥ Checkout cÃ³digo"
      uses: actions/checkout@v4
    
    # 2. SETUP PYTHON (visible)  
    - name: "ğŸ Setup Python 3.11"
      uses: actions/setup-python@v3
      with:
        python-version: "3.11"
    
    # 3. INSTALL DEPS (visible)
    - name: "ğŸ“¦ Install dependencies"
      run: pip install -r requirements.txt
    
    # 4. LINTING (visible)
    - name: "ğŸ” Check Linting (Ruff)"
      run: ruff check .
    
    # 5. TESTS (visible)
    - name: "ğŸ§ª Test with pytest"
      run: pytest tests.py
    
    # 6. LOGIN (visible)
    - name: "ğŸ”‘ Login to GitHub Container Registry"
      uses: docker/login-action@v3
      with:
        registry: ghcr.io
        username: ${{ github.actor }}
        password: ${{ secrets.GITHUB_TOKEN }}
    
    # 7. METADATA
    - name: "ğŸ·ï¸ Extract metadata"
      id: meta
      uses: docker/metadata-action@v5
      with:
        images: ghcr.io/${{ github.repository }}
    
    # 8. BUILD AND PUSH (visible - aquÃ­ estaba el link)
    - name: "ğŸ³ Build and push Docker image"
      id: docker_build
      uses: docker/build-push-action@v6
      with:
        context: .
        push: true
        tags: ${{ steps.meta.outputs.tags }}
        labels: ${{ steps.meta.outputs.labels }}
    
    # 9. ğŸ”¥ NUEVO: MOSTRAR LINK PARA DESPLEGAR
    - name: "ğŸš€ Show deployment commands"
      run: |
        echo "========================================="
        echo "âœ… IMAGEN CONSTRUIDA Y PUBLICADA"
        echo "========================================="
        echo ""
        echo "ğŸ“¦ IMAGEN: ghcr.io/${{ github.repository }}:latest"
        echo ""
        echo "ğŸ”— PARA DESCARGAR Y EJECUTAR LOCALMENTE:"
        echo "docker pull ghcr.io/${{ github.repository }}:latest"
        echo "docker run -d -p 8080:80 ghcr.io/${{ github.repository }}:latest"
        echo ""
        echo "ğŸ”— ACCEDER EN NAVEGADOR:"
        echo "http://localhost:8080"
        echo ""
        echo "ğŸ”— VER IMAGEN EN GITHUB PACKAGES:"
        echo "https://github.com/${{ github.repository }}/pkgs/container/$(echo ${{ github.repository }} | cut -d'/' -f2)"
        echo "========================================="