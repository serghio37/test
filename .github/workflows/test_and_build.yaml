name: Docker CI/CD Pipeline

on:
  push:
    branches: ["main"]

jobs:
  pipeline:
    runs-on: ubuntu-latest
    
    steps:
    - name: "ðŸ“¥ Checkout cÃ³digo"
      uses: actions/checkout@v4
    
    - name: "ðŸ Setup Python"
      uses: actions/setup-python@v3
      with:
        python-version: "3.11"
    
    - name: "ðŸ“¦ Instalar dependencias"
      run: pip install -r requirements.txt
    
    - name: "ðŸ” Linting"
      run: ruff check . || echo "Linting encontrÃ³ errores"
    
    - name: "ðŸ§ª Tests"
      run: pytest tests.py -v || echo "Tests fallaron"
    
    - name: "ðŸ”¨ Construir imagen Docker"
      run: |
        echo "=== CONSTRUYENDO IMAGEN DOCKER ==="
        docker build -t mi-sitio-web:latest .
        echo "âœ… Imagen construida: mi-sitio-web:latest"
    
    - name: "ðŸš€ Crear y mostrar contenedor"
      run: |
        echo "========================================"
        echo "ðŸ³ CREANDO Y MOSTRANDO CONTENEDOR DOCKER"
        echo "========================================"
        
        docker stop mi-contenedor 2>/dev/null || true
        docker rm mi-contenedor 2>/dev/null || true
        
        echo ""
        echo "ðŸš€ EJECUTANDO CONTENEDOR..."
        docker run -d --name mi-contenedor -p 8080:80 mi-sitio-web:latest
        
        sleep 5
        
        echo ""
        echo "========================================"
        echo "ðŸ“Š CONTENEDOR EN EJECUCIÃ“N"
        echo "========================================"
        echo ""
        echo "ðŸ“‹ docker ps:"
        echo "----------------------------------------"
        docker ps --format "table {{.Names}}\t{{.Image}}\t{{.Status}}\t{{.Ports}}"
        
        echo ""
        echo "ðŸ” docker inspect (simplificado):"
        echo "----------------------------------------"
        docker inspect mi-contenedor --format '{{.Name}} - {{.State.Status}} - {{range .NetworkSettings.Ports}}{{.HostPort}}{{end}}'
        
        echo ""
        echo "ðŸ“œ docker logs (Ãºltimas 5 lÃ­neas):"
        echo "----------------------------------------"
        docker logs mi-contenedor --tail 5
        
        echo ""
        echo "ðŸŒ Probando sitio web..."
        echo "----------------------------------------"
        if curl -s -f http://localhost:8080 > /dev/null; then
          echo "âœ… HTTP 200 OK - Servidor funcionando"
          echo ""
          echo "ðŸ“„ Contenido (primeras lÃ­neas):"
          curl -s http://localhost:8080 | head -10
        else
          echo "âš ï¸ El servidor no respondiÃ³"
        fi
        
        echo ""
        echo "ðŸ§¹ Limpiando contenedor..."
        docker stop mi-contenedor
        docker rm mi-contenedor
        echo "âœ… Contenedor eliminado"
        
        echo ""
        echo "========================================"
        echo "ðŸŽ‰ CONTENEDOR CREADO Y PROBADO EXITOSAMENTE"
        echo "========================================"
    
    - name: "ðŸ“‹ Resumen final"
      run: |
        echo "## ðŸŽ‰ PIPELINE COMPLETADO" >> $GITHUB_STEP_SUMMARY
        echo "" >> $GITHUB_STEP_SUMMARY
        echo "### âœ… Contenedor Docker creado y probado" >> $GITHUB_STEP_SUMMARY
        echo "" >> $GITHUB_STEP_SUMMARY
        echo '```bash' >> $GITHUB_STEP_SUMMARY
        echo "# Para replicar localmente:" >> $GITHUB_STEP_SUMMARY
        echo "docker build -t mi-sitio-web ." >> $GITHUB_STEP_SUMMARY
        echo "docker run -d -p 8080:80 mi-sitio-web" >> $GITHUB_STEP_SUMMARY
        echo "docker ps" >> $GITHUB_STEP_SUMMARY
        echo '```' >> $GITHUB_STEP_SUMMARY