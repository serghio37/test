name: ğŸš€ Docker CI/CD Pipeline Completo

on:
  push:
    branches: [ "main" ]
  pull_request:
    branches: [ "main" ]

permissions:
  contents: read
  packages: write
  id-token: write

jobs:
  ci_cd_pipeline:
    runs-on: ubuntu-latest
    
    permissions:
      contents: read
      packages: write
      id-token: write
    
    steps:
    # ==================== FASE 1: PREPARACIÃ“N ====================
    - name: "ğŸ“¥ Checkout cÃ³digo"
      uses: actions/checkout@v4
    
    # ==================== FASE 2: TESTS PYTHON ====================
    - name: "ğŸ Setup Python 3.11"
      uses: actions/setup-python@v3
      with:
        python-version: "3.11"
    
    - name: "ğŸ“¦ Install Python dependencies"
      run: |
        python -m pip install --upgrade pip
        pip install -r requirements.txt
    
    - name: "ğŸ” Linting con Ruff"
      run: ruff check . --output-format=github
    
    - name: "ğŸ§ª Tests con pytest"
      run: |
        echo "=== EJECUTANDO TESTS PYTHON ==="
        pytest tests.py -v
        echo "âœ… Tests completados"
    
    # ==================== FASE 3: BUILD DOCKER ====================
    - name: "ğŸ”‘ Login a GitHub Container Registry"
      uses: docker/login-action@v3
      with:
        registry: ghcr.io
        username: ${{ github.actor }}
        password: ${{ secrets.GITHUB_TOKEN }}
    
    - name: "ğŸ·ï¸ Configurar tags de imagen"
      id: meta
      run: |
        echo "REPO=${{ github.repository }}" >> $GITHUB_ENV
        echo "OWNER=${{ github.repository_owner }}" >> $GITHUB_ENV
        echo "SHA_SHORT=$(echo ${{ github.sha }} | cut -c1-7)" >> $GITHUB_ENV
        echo "tags=ghcr.io/${{ github.repository }}:latest,ghcr.io/${{ github.repository }}:${{ github.sha }}" >> $GITHUB_OUTPUT
    
    - name: "ğŸ³ Construir imagen Docker"
      id: docker_build
      run: |
        echo "=== CONSTRUYENDO IMAGEN DOCKER ==="
        docker build -t ghcr.io/${{ github.repository }}:latest .
        echo "âœ… Imagen construida: ghcr.io/${{ github.repository }}:latest"
    
    - name: "ğŸ“¤ Push imagen a GitHub Packages"
      run: |
        echo "=== SUBIENDO IMAGEN A REGISTRY ==="
        docker push ghcr.io/${{ github.repository }}:latest
        docker push ghcr.io/${{ github.repository }}:${{ github.sha }}
        echo "âœ… Imagen almacenada en GitHub Packages"
    
    # ==================== FASE 4: TEST CONTENEDOR ====================
    - name: "ğŸ§ª Probar contenedor Docker (crear y mostrar)"
      run: |
        echo ""
        echo "========================================="
        echo "ğŸ³ TESTEO DE CONTENEDOR DOCKER EN ACCIÃ“N"
        echo "========================================="
        
        # 1. Descargar imagen reciÃ©n creada
        echo ""
        echo "ğŸ“¥ DESCARGANDO IMAGEN DEL REGISTRY..."
        docker pull ghcr.io/${{ github.repository }}:latest
        
        # 2. Crear y ejecutar contenedor
        echo ""
        echo "ğŸš€ CREANDO CONTENEDOR..."
        docker run -d \
          --name mi-sitio-web-test \
          --hostname nginx-docker \
          -p 8080:80 \
          ghcr.io/${{ github.repository }}:latest
        
        # 3. Esperar que Nginx inicie
        echo ""
        echo "â³ ESPERANDO INICIO DEL SERVIDOR (5 segundos)..."
        sleep 5
        
        # 4. MOSTRAR CONTENEDOR CREADO (Â¡ESTE ES EL PUNTO CLAVE!)
        echo ""
        echo "========================================="
        echo "ğŸ“Š CONTENEDOR EN EJECUCIÃ“N"
        echo "========================================="
        echo ""
        echo "ğŸ“‹ LISTA DE CONTENEDORES ACTIVOS:"
        echo "-----------------------------------------"
        docker ps --format "table {{.Names}}\t{{.Image}}\t{{.Status}}\t{{.Ports}}\t{{.CreatedAt}}"
        echo ""
        
        # 5. Mostrar detalles del contenedor
        echo "ğŸ” INFORMACIÃ“N DETALLADA DEL CONTENEDOR:"
        echo "-----------------------------------------"
        docker inspect mi-sitio-web-test --format \
          "Nombre: {{.Name}}
Estado: {{.State.Status}} (desde {{.State.StartedAt}})
IP Interna: {{range .NetworkSettings.Networks}}{{.IPAddress}}{{end}}
Puerto Mapeado: 8080 â†’ 80
ID: {{.Id}}
Imagen: {{.Config.Image}}"
        echo ""
        
        # 6. Mostrar logs
        echo "ğŸ“œ ÃšLTIMOS LOGS DEL SERVIDOR NGINX:"
        echo "-----------------------------------------"
        docker logs mi-sitio-web-test --tail 8
        echo ""
        
        # 7. Probar que el sitio web funciona
        echo "ğŸŒ PRUEBA DEL SITIO WEB:"
        echo "-----------------------------------------"
        echo "Probando conexiÃ³n a http://localhost:8080 ..."
        
        if curl -s -f http://localhost:8080 > /dev/null; then
          echo "âœ… CONEXIÃ“N EXITOSA - Servidor respondiendo"
          echo ""
          echo "ğŸ“„ CONTENIDO DE LA PÃGINA (extracto):"
          curl -s http://localhost:8080 | grep -E "<title>|</h1>|</p>" | head -5
        else
          echo "âŒ ERROR: El servidor no respondiÃ³"
          exit 1
        fi
        
        echo ""
        
        # 8. EstadÃ­sticas
        echo "ğŸ“Š ESTADÃSTICAS DEL CONTENEDOR:"
        echo "-----------------------------------------"
        docker stats mi-sitio-web-test --no-stream --format \
          "CPU: {{.CPUPerc}}\nMemoria: {{.MemUsage}}\n"
        
        # 9. Limpiar
        echo ""
        echo "ğŸ§¹ LIMPIANDO CONTENEDOR DE PRUEBA..."
        docker stop mi-sitio-web-test
        docker rm mi-sitio-web-test
        echo "âœ… Contenedor detenido y eliminado"
        
        echo ""
        echo "========================================="
        echo "ğŸ‰ TODAS LAS PRUEBAS COMPLETADAS EXITOSAMENTE"
        echo "========================================="
    
    # ==================== FASE 5: RESUMEN Y ENLACES ====================
    - name: "ğŸ“‹ Generar resumen del despliegue"
      if: success()
      run: |
        echo "## ğŸš€ DESPLIEGUE COMPLETADO EXITOSAMENTE" >> $GITHUB_STEP_SUMMARY
        echo "" >> $GITHUB_STEP_SUMMARY
        echo "### ğŸ“¦ Imagen Docker Publicada" >> $GITHUB_STEP_SUMMARY
        echo "- **Latest:** \`ghcr.io/${{ github.repository }}:latest\`" >> $GITHUB_STEP_SUMMARY
        echo "- **Commit:** \`ghcr.io/${{ github.repository }}:${{ github.sha }}\`" >> $GITHUB_STEP_SUMMARY
        echo "" >> $GITHUB_STEP_SUMMARY
        echo "### ğŸ³ Comandos para Usar la Imagen" >> $GITHUB_STEP_SUMMARY
        echo '```bash' >> $GITHUB_STEP_SUMMARY
        echo "# Descargar imagen" >> $GITHUB_STEP_SUMMARY
        echo "docker pull ghcr.io/${{ github.repository }}:latest" >> $GITHUB_STEP_SUMMARY
        echo "" >> $GITHUB_STEP_SUMMARY
        echo "# Ejecutar contenedor" >> $GITHUB_STEP_SUMMARY
        echo "docker run -d -p 8080:80 --name mi-sitio ghcr.io/${{ github.repository }}:latest" >> $GITHUB_STEP_SUMMARY
        echo "" >> $GITHUB_STEP_SUMMARY
        echo "# Ver contenedor en ejecuciÃ³n" >> $GITHUB_STEP_SUMMARY
        echo "docker ps" >> $GITHUB_STEP_SUMMARY
        echo '```' >> $GITHUB_STEP_SUMMARY
        echo "" >> $GITHUB_STEP_SUMMARY
        echo "### ğŸ”— Enlaces" >> $GITHUB_STEP_SUMMARY
        echo "- ğŸ“Š [Ver este workflow](${{ github.server_url }}/${{ github.repository }}/actions/runs/${{ github.run_id }})" >> $GITHUB_STEP_SUMMARY
        echo "- ğŸ“¦ [Ver imagen en GitHub Packages](https://github.com/${{ github.repository }}/pkgs/container/$(echo ${{ github.repository }} | cut -d'/' -f2))" >> $GITHUB_STEP_SUMMARY
        echo "- ğŸŒ [Acceder al sitio](http://localhost:8080) (despuÃ©s de ejecutar contenedor)" >> $GITHUB_STEP_SUMMARY
    
    # ==================== FASE 6: NOTIFICACIÃ“N (OPCIONAL) ====================
    - name: "ğŸ“¢ Notificar Ã©xito"
      if: success()
      run: |
        echo "âœ… PIPELINE COMPLETADO - $(date)"
        echo "ğŸ• DuraciÃ³n: ${{ job.status }}"
        echo "ğŸ“Š Resumen disponible en la pestaÃ±a 'Summary'"