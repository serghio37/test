name: üöÄ Docker CI/CD Pipeline Completo

on:
  push:
    branches: ["main"]
  pull_request:
    branches: ["main"]

permissions:
  contents: read
  packages: write
  id-token: write

jobs:
  ci_cd_pipeline:
    runs-on: ubuntu-latest
    
    permissions:
      contents: read
      packages: write
      id-token: write
    
    steps:
    # ==================== FASE 1: PREPARACI√ìN ====================
    - name: "üì• Checkout c√≥digo"
      uses: actions/checkout@v4
    
    # ==================== FASE 2: TESTS PYTHON ====================
    - name: "üêç Setup Python 3.11"
      uses: actions/setup-python@v3
      with:
        python-version: "3.11"
    
    - name: "üì¶ Install Python dependencies"
      run: |
        python -m pip install --upgrade pip
        pip install -r requirements.txt
    
    - name: "üîç Linting con Ruff"
      run: ruff check . --output-format=github
    
    - name: "üß™ Tests con pytest"
      run: |
        echo "=== EJECUTANDO TESTS PYTHON ==="
        pytest tests.py -v
        echo "‚úÖ Tests completados"
    
    # ==================== FASE 3: BUILD DOCKER ====================
    - name: "üîë Login a GitHub Container Registry"
      uses: docker/login-action@v3
      with:
        registry: ghcr.io
        username: ${{ github.actor }}
        password: ${{ secrets.GITHUB_TOKEN }}
    
    - name: "üê≥ Construir imagen Docker"
      id: docker_build
      run: |
        echo "=== CONSTRUYENDO IMAGEN DOCKER ==="
        docker build -t ghcr.io/${{ github.repository }}:latest .
        echo "‚úÖ Imagen construida: ghcr.io/${{ github.repository }}:latest"
    
    - name: "üì§ Push imagen a GitHub Packages"
      run: |
        echo "=== SUBIENDO IMAGEN A REGISTRY ==="
        docker push ghcr.io/${{ github.repository }}:latest
        docker push ghcr.io/${{ github.repository }}:${{ github.sha }}
        echo "‚úÖ Imagen almacenada en GitHub Packages"
    
    # ==================== FASE 4: TEST CONTENEDOR ====================
    - name: "üß™ Probar contenedor Docker"
      run: |
        echo ""
        echo "========================================="
        echo "üê≥ TESTEO DE CONTENEDOR DOCKER EN ACCI√ìN"
        echo "========================================="
        
        # 1. Descargar imagen reci√©n creada
        echo ""
        echo "üì• DESCARGANDO IMAGEN DEL REGISTRY..."
        docker pull ghcr.io/${{ github.repository }}:latest
        
        # 2. Crear y ejecutar contenedor
        echo ""
        echo "üöÄ CREANDO CONTENEDOR..."
        docker run -d \
          --name mi-sitio-web-test \
          --hostname nginx-docker \
          -p 8080:80 \
          ghcr.io/${{ github.repository }}:latest
        
        # 3. Esperar que Nginx inicie
        echo ""
        echo "‚è≥ ESPERANDO INICIO DEL SERVIDOR (5 segundos)..."
        sleep 5
        
        # 4. MOSTRAR CONTENEDOR CREADO
        echo ""
        echo "========================================="
        echo "üìä CONTENEDOR EN EJECUCI√ìN"
        echo "========================================="
        echo ""
        echo "üìã LISTA DE CONTENEDORES ACTIVOS:"
        echo "-----------------------------------------"
        docker ps --format "table {{.Names}}\t{{.Image}}\t{{.Status}}\t{{.Ports}}\t{{.CreatedAt}}"
        echo ""
        
        # 5. Mostrar detalles del contenedor
        echo "üîç INFORMACI√ìN DETALLADA DEL CONTENEDOR:"
        echo "-----------------------------------------"
        docker inspect mi-sitio-web-test --format "Nombre: {{.Name}}
        Estado: {{.State.Status}} (desde {{.State.StartedAt}})
        IP Interna: {{range .NetworkSettings.Networks}}{{.IPAddress}}{{end}}
        Puerto Mapeado: 8080 ‚Üí 80
        ID: {{.Id}}
        Imagen: {{.Config.Image}}"
        echo ""
        
        # 6. Mostrar logs
        echo "üìú √öLTIMOS LOGS DEL SERVIDOR NGINX:"
        echo "-----------------------------------------"
        docker logs mi-sitio-web-test --tail 8
        echo ""
        
        # 7. Probar que el sitio web funciona
        echo "üåê PRUEBA DEL SITIO WEB:"
        echo "-----------------------------------------"
        echo "Probando conexi√≥n a http://localhost:8080 ..."
        
        if curl -s -f http://localhost:8080 > /dev/null; then
          echo "‚úÖ CONEXI√ìN EXITOSA - Servidor respondiendo"
          echo ""
          echo "üìÑ CONTENIDO DE LA P√ÅGINA (extracto):"
          curl -s http://localhost:8080 | grep -E "<title>|</h1>|</p>" | head -5
        else
          echo "‚ùå ERROR: El servidor no respondi√≥"
          exit 1
        fi
        
        echo ""
        
        # 8. Limpiar
        echo "üßπ LIMPIANDO CONTENEDOR DE PRUEBA..."
        docker stop mi-sitio-web-test
        docker rm mi-sitio-web-test
        echo "‚úÖ Contenedor detenido y eliminado"
        
        echo ""
        echo "========================================="
        echo "üéâ TODAS LAS PRUEBAS COMPLETADAS EXITOSAMENTE"
        echo "========================================="
    
    # ==================== FASE 5: RESUMEN Y ENLACES ====================
    - name: "üìã Generar resumen del despliegue"
      if: success()
      run: |
        echo "## üöÄ DESPLIEGUE COMPLETADO EXITOSAMENTE" >> $GITHUB_STEP_SUMMARY
        echo "" >> $GITHUB_STEP_SUMMARY
        echo "### üì¶ Imagen Docker Publicada" >> $GITHUB_STEP_SUMMARY
        echo "- **Latest:** \`ghcr.io/${{ github.repository }}:latest\`" >> $GITHUB_STEP_SUMMARY
        echo "- **Commit:** \`ghcr.io/${{ github.repository }}:${{ github.sha }}\`" >> $GITHUB_STEP_SUMMARY
        echo "" >> $GITHUB_STEP_SUMMARY
        echo "### üê≥ Comandos para Usar la Imagen" >> $GITHUB_STEP_SUMMARY
        echo '```bash' >> $GITHUB_STEP_SUMMARY
        echo "# Descargar imagen" >> $GITHUB_STEP_SUMMARY
        echo "docker pull ghcr.io/${{ github.repository }}:latest" >> $GITHUB_STEP_SUMMARY
        echo "" >> $GITHUB_STEP_SUMMARY
        echo "# Ejecutar contenedor" >> $GITHUB_STEP_SUMMARY
        echo "docker run -d -p 8080:80 --name mi-sitio ghcr.io/${{ github.repository }}:latest" >> $GITHUB_STEP_SUMMARY
        echo "" >> $GITHUB_STEP_SUMMARY
        echo "# Ver contenedor en ejecuci√≥n" >> $GITHUB_STEP_SUMMARY
        echo "docker ps" >> $GITHUB_STEP_SUMMARY
        echo '```' >> $GITHUB_STEP_SUMMARY
        echo "" >> $GITHUB_STEP_SUMMARY
        echo "### üîó Enlaces" >> $GITHUB_STEP_SUMMARY
        echo "- üìä [Ver este workflow](${{ github.server_url }}/${{ github.repository }}/actions/runs/${{ github.run_id }})" >> $GITHUB_STEP_SUMMARY
        echo "- üì¶ [Ver imagen en GitHub Packages](https://github.com/${{ github.repository }}/pkgs/container/$(echo ${{ github.repository }} | cut -d'/' -f2))" >> $GITHUB_STEP_SUMMARY
        echo "- üåê [Acceder al sitio](http://localhost:8080) (despu√©s de ejecutar contenedor)" >> $GITHUB_STEP_SUMMARY