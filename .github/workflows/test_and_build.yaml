name: Docker CI/CD Pipeline

on:
  push:
    branches: [ "main" ]
  pull_request:
    branches: [ "main" ]

permissions:
  contents: read
  packages: write
  
jobs:
  # JOB 1: TESTS Y CALIDAD
  test:
    runs-on: ubuntu-latest
    steps:
    - uses: actions/checkout@v4
    
    - name: Set up Python
      uses: actions/setup-python@v3
      with:
        python-version: "3.11"
    
    - name: Install dependencies
      run: pip install -r requirements.txt
    
    - name: Check Linting
      run: ruff check .
    
    - name: Test with pytest
      run: pytest tests.py

  # JOB 2: CONSTRUIR Y ALMACENAR IMAGEN DOCKER (Â¡ESTO CUMPLE "ALMACENAR SITIO WEB"!)
  build-and-store:
    needs: test
    runs-on: ubuntu-latest
    
    steps:
    - uses: actions/checkout@v4
    
    - name: Login to GitHub Container Registry
      uses: docker/login-action@v3
      with:
        registry: ghcr.io
        username: ${{ github.actor }}
        password: ${{ secrets.GITHUB_TOKEN }}
    
    - name: Build Docker image (Â¡CONSTRUYE CON EL SITIO WEB DENTRO!)
      run: |
        docker build -t ghcr.io/${{ github.repository_owner }}/mi-sitio-web:latest .
        echo "âœ… Sitio web almacenado en imagen Docker"
    
    - name: Push to GitHub Container Registry (Â¡ALMACENA EN REGISTRY!)
      run: |
        docker push ghcr.io/${{ github.repository_owner }}/mi-sitio-web:latest
        echo "âœ… Sitio web almacenado en GitHub Packages"
    
    - name: Verify stored image
      run: |
        echo "ðŸ“¦ Imagen Docker almacenada con sitio web:"
        echo "ghcr.io/${{ github.repository_owner }}/mi-sitio-web:latest"
        echo "ðŸ”— URL: https://github.com/${{ github.repository }}/pkgs/container/mi-sitio-web"

  # JOB 3: DESPLEGAR (OPCIONAL - para completar automatizaciÃ³n)
  deploy:
    needs: build-and-store
    runs-on: ubuntu-latest
    if: github.ref == 'refs/heads/main'
    
    steps:
    - name: Deploy to GitHub Container Registry (ejemplo alternativo)
      run: |
        echo "ðŸš€ AquÃ­ irÃ­a despliegue a producciÃ³n"
        echo "Ejemplos:"
        echo "- docker run -d -p 80:80 ghcr.io/.../mi-sitio-web"
        echo "- kubectl apply -f deployment.yaml"
        echo "- docker-compose up -d"