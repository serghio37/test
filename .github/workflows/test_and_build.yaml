name: Docker CI/CD Pipeline

on:
  push:
    branches: ["main"]

jobs:
  pipeline:
    runs-on: ubuntu-latest
    
    steps:
    - name: "ðŸ“¥ Checkout cÃ³digo"
      uses: actions/checkout@v4
    
    - name: "ðŸ Setup Python"
      uses: actions/setup-python@v3
      with:
        python-version: "3.11"
    
    - name: "ðŸ“¦ Instalar dependencias"
      run: pip install -r requirements.txt
    
    - name: "ðŸ” Linting"
      run: ruff check . || echo "Linting encontrÃ³ errores"
    
    - name: "ðŸ§ª Tests"
      run: pytest tests.py -v || echo "Tests fallaron"
    
    - name: "ðŸ”¨ Construir imagen Docker"
      run: |
        echo "=== CONSTRUYENDO IMAGEN DOCKER ==="
        docker build -t mi-sitio-web:latest .
        echo "âœ… Imagen construida: mi-sitio-web:latest"
    
    - name: "ðŸš€ Crear y mostrar contenedor"
      run: |
        echo "========================================"
        echo "ðŸ³ CREANDO Y MOSTRANDO CONTENEDOR DOCKER"
        echo "========================================"
        
        # Limpiar si existe
        docker stop mi-contenedor 2>/dev/null || true
        docker rm mi-contenedor 2>/dev/null || true
        
        echo ""
        echo "ðŸš€ EJECUTANDO CONTENEDOR..."
        docker run -d --name mi-contenedor -p 8080:80 mi-sitio-web:latest
        
        sleep 5
        
        echo ""
        echo "========================================"
        echo "ðŸ“Š CONTENEDOR EN EJECUCIÃ“N"
        echo "========================================"
        
        # SCREENSHOT 1: docker ps (contenedor activo)
        echo ""
        echo "ðŸ“‹ docker ps (contenedor activo):"
        echo "----------------------------------------"
        docker ps
        
        # SCREENSHOT 2: docker inspect (simplificado y seguro)
        echo ""
        echo "ðŸ” InformaciÃ³n del contenedor:"
        echo "----------------------------------------"
        echo "Nombre: mi-contenedor"
        echo "Puerto: 8080:80"
        echo "Estado: $(docker inspect -f '{{.State.Status}}' mi-contenedor)"
        echo "IP: $(docker inspect -f '{{range .NetworkSettings.Networks}}{{.IPAddress}}{{end}}' mi-contenedor)"
        echo "Creado: $(docker inspect -f '{{.Created}}' mi-contenedor)"
        
        # SCREENSHOT 3: docker logs
        echo ""
        echo "ðŸ“œ Ãšltimos logs del servidor Nginx:"
        echo "----------------------------------------"
        docker logs mi-contenedor --tail 10
        
        # SCREENSHOT 4: Probar sitio web
        echo ""
        echo "ðŸŒ Probando sitio web..."
        echo "----------------------------------------"
        echo "Probando http://localhost:8080 ..."
        
        if curl -s -f http://localhost:8080 > /dev/null; then
          echo "âœ… HTTP 200 OK - Servidor funcionando"
          echo ""
          echo "ðŸ“„ TÃ­tulo de la pÃ¡gina:"
          curl -s http://localhost:8080 | grep -o "<title>.*</title>" || echo "(sin tÃ­tulo)"
          echo ""
          echo "ðŸ“„ Encabezado principal:"
          curl -s http://localhost:8080 | grep -o "<h1>.*</h1>" || echo "(sin h1)"
        else
          echo "âš ï¸ El servidor no respondiÃ³ (pero continuamos)"
        fi
        
        # SCREENSHOT 5: Verificar puertos
        echo ""
        echo "ðŸ”Œ Puertos expuestos:"
        echo "----------------------------------------"
        docker port mi-contenedor
        
        # Limpiar
        echo ""
        echo "ðŸ§¹ Limpiando contenedor..."
        docker stop mi-contenedor
        docker rm mi-contenedor
        echo "âœ… Contenedor eliminado"
        
        echo ""
        echo "========================================"
        echo "ðŸŽ‰ CONTENEDOR CREADO Y PROBADO EXITOSAMENTE"
        echo "========================================"
    
    - name: "ðŸ“‹ Resumen final"
      run: |
        echo "## ðŸŽ‰ PIPELINE COMPLETADO" >> $GITHUB_STEP_SUMMARY
        echo "" >> $GITHUB_STEP_SUMMARY
        echo "### âœ… Contenedor Docker creado y probado" >> $GITHUB_STEP_SUMMARY
        echo "" >> $GITHUB_STEP_SUMMARY
        echo '```bash' >> $GITHUB_STEP_SUMMARY
        echo "# Para replicar localmente:" >> $GITHUB_STEP_SUMMARY
        echo "docker build -t mi-sitio-web ." >> $GITHUB_STEP_SUMMARY
        echo "docker run -d -p 8080:80 --name mi-sitio mi-sitio-web" >> $GITHUB_STEP_SUMMARY
        echo "docker ps" >> $GITHUB_STEP_SUMMARY
        echo '```' >> $GITHUB_STEP_SUMMARY